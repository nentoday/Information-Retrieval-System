<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Article Search</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container mt-5">
    <h1 class="mb-4 text-center">üîç Article Search</h1>

    <div class="input-group mb-3">
        <input type="text" class="form-control" id="searchInput" placeholder="Enter a keyword...">
        <button class="btn btn-primary" onclick="search()">Search</button>
        <button class="btn btn-secondary" onclick="translate()">Translate Results</button>
    </div>

    <div id="results" class="row gy-4"></div>
</div>

<script>
    let rawResults = [];

    function search() {
        const keyword = document.getElementById("searchInput").value.trim();
        if (!keyword) return;

        fetch(`/search?q=${encodeURIComponent(keyword)}`)
            .then(response => response.json())
            .then(data => {
                rawResults = data;
                displayResults(data, false);
            })
            .catch(error => console.error("Error:", error));
    }

    function translate() {
        const translatedResults = rawResults.map(row => {
            return fetch(`/translate`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ title: row.title, text: row.article_text })
            }).then(response => response.json().then(t => ({
                id: row.id,
                title: row.title,
                article_text: row.article_text,
                translated_title: t.translated_title,
                translated_text: t.translated_text
            })));
        });

        Promise.all(translatedResults).then(data => {
            displayResults(data, true);
        });
    }

    function displayResults(data, isTranslated) {
        const resultsContainer = document.getElementById("results");
        resultsContainer.innerHTML = "";

        data.forEach(row => {
            const col = document.createElement("div");
            col.className = "col-12";

            col.innerHTML = `
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><strong>Original Title:</strong></h6>
                                <p>${row.title}</p>
                                <h6><strong>Original Text:</strong></h6>
                                <p style="max-height: 100px; overflow-y: auto;">${row.article_text}</p>
                            </div>
                            <div class="col-md-6 border-start">
                                <h6><strong>Translated Title:</strong></h6>
                                <p>${isTranslated ? row.translated_title : '<em>Click "Translate Results" to see</em>'}</p>
                                <h6><strong>Translated Text:</strong></h6>
                                <p style="max-height: 100px; overflow-y: auto;">
                                    ${isTranslated ? row.translated_text : '<em>Click "Translate Results" to see</em>'}
                                </p>
                            </div>
                        </div>
                        <a class="btn btn-link mt-2" href="/article/${row.id}" target="_blank">View Full Article</a>
                    </div>
                </div>
            `;
            resultsContainer.appendChild(col);
        });
    }
</script>
</body>
</html>
